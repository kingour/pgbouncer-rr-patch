--- ../pgbouncer/src/client.c	2022-03-23 18:00:47.000000000 +0800
+++ ./src/client.c	2022-08-25 15:11:55.000000000 +0800
@@ -945,6 +945,14 @@ static bool handle_client_work(PgSocket 
 	if (client->pool->db->admin)
 		return admin_handle_client(client, pkt);
 
+        /* pgbouncer-rr extensions: query rewrite & client connection routing */
+        if (pkt->type == 'Q' || pkt->type == 'P') {
+                if (!rewrite_query(client, pkt)) {
+                        return false;
+                }
+                route_client_connection(client, pkt);
+        }
+
 	/* acquire server */
 	if (!find_server(client))
 		return false;
